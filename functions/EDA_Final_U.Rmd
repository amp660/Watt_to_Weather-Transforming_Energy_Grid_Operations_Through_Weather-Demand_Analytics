
---
title: "Weather-Energy Relationship Analysis"
subtitle: "Advanced Statistical Exploration and Modeling"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: cosmo
    highlight: tango
    code_folding: show
date: "2025-05-05"
author: "Student Name"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```


Executive Summary
This analysis explores the relationship between weather conditions and energy demand/consumption across various US regions. Using advanced statistical techniques, we identify a clear U-shaped relationship between temperature and energy demand, with increased consumption at both high and low temperature extremes. We quantify optimal temperature points, regional sensitivity variations, and economic implications of temperature deviations. The results provide actionable insights for energy providers, regulators, and consumers to optimize energy systems for changing weather patterns.

Key Findings:
U-Shaped Temperature-Demand Relationship: Energy demand follows a robust U-shaped pattern with temperature, minimizing at approximately 51.5째F.
Regional Variations: Weather sensitivity varies substantially by region, with ERCO (Texas) showing the highest elasticity to temperature changes.
Seasonal Effects: Summer demand exceeds winter by a significant margin, with clear statistical significance in seasonal patterns.
High Predictive Accuracy: Advanced modeling techniques achieve high accuracy in predicting energy demand based on weather variables.
Economic Implications: Each 1째F deviation from optimal temperature increases energy demand by approximately 2.03%.

```{r}
# 1. SETUP AND DATA PREPARATION
#------------------------------------------------------
# Load required libraries
library(tidyverse)      # Data manipulation and visualization
library(mgcv)           # For GAM modeling
library(lmtest)         # For hypothesis testing
library(car)            # For VIF analysis
library(quantreg)       # For quantile regression
library(segmented)      # For breakpoint analysis
library(Hmisc)          # For statistical tests
library(gridExtra)      # For grid plots
library(nlme)           # For mixed-effects models
library(sandwich)       # For robust standard errors
library(boot)           # For bootstrapping
library(performance)    # For model diagnostics
library(effects)        # For effect plots
library(MASS)           # For robust regression
library(corrplot)       # For correlation plots
library(viridis)        # For better color palettes
library(scales)         # For scale formatting
library(randomForest)   # For random forest models
library(gbm)            # For gradient boosting
library(caret)          # For model training and validation
library(patchwork)      # For combining plots
library(kableExtra)     # For pretty tables

# Record package versions for reproducibility
pkg_versions <- sapply(c("tidyverse", "mgcv", "lmtest", "car", "quantreg", "segmented", 
                        "nlme", "sandwich", "boot", "randomForest", "caret"), 
                      packageVersion)
pkg_versions_df <- data.frame(
  Package = names(pkg_versions),
  Version = as.character(pkg_versions)
)

# Display package versions
kable(pkg_versions_df, caption = "Package Versions") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)

# Set seed for reproducibility
set.seed(123)

# Load the merged data
merged_data <- readRDS("../data/processed/merged_data.rds")

# Check the dimensions of the loaded data
cat("Loaded merged data with dimensions:", dim(merged_data), "\n")
cat("Date range:", min(merged_data$date), "to", max(merged_data$date), "\n")
cat("Number of locations:", n_distinct(merged_data$location), "\n")
cat("Number of energy regions:", n_distinct(merged_data$energy_region), "\n")
```

Data Cleaning and Transformation

```{r}
# 2. DATA CLEANING AND TRANSFORMATION
#------------------------------------------------------
# Convert value to numeric and add derived variables
merged_data <- merged_data %>%
  mutate(
    # Convert energy value to numeric
    energy_value = as.numeric(value),
    
    # Create time-based variables
    month = month(date, label = TRUE),
    season = case_when(
      month %in% c("Dec", "Jan", "Feb") ~ "Winter",
      month %in% c("Mar", "Apr", "May") ~ "Spring",
      month %in% c("Jun", "Jul", "Aug") ~ "Summer",
      month %in% c("Sep", "Oct", "Nov") ~ "Fall"
    ),
    weekday = wday(date, label = TRUE),
    is_weekend = weekday %in% c("Sat", "Sun"),
    
    # Create temperature bins for categorical analysis
    temp_bin = cut(temp_mean, 
                  breaks = seq(0, 100, by = 10),
                  labels = paste0(seq(0, 90, by = 10), "-", seq(10, 100, by = 10), "째F")),
    
    # Create humidity bins
    humidity_bin = cut(humidity_mean,
                      breaks = seq(0, 100, by = 20),
                      labels = paste0(seq(0, 80, by = 20), "-", seq(20, 100, by = 20), "%"))
  )

# Check for missing values
missing_summary <- merged_data %>%
  summarise(across(everything(), ~sum(is.na(.)))) %>%
  pivot_longer(everything(), names_to = "Variable", values_to = "Missing_Count") %>%
  filter(Missing_Count > 0) %>%
  arrange(desc(Missing_Count)) %>%
  mutate(Missing_Percent = Missing_Count / nrow(merged_data) * 100)

# Display missing values summary
if(nrow(missing_summary) > 0) {
  kable(missing_summary, caption = "Missing Values Summary") %>%
    kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
} else {
  cat("No missing values found in the dataset.")
}

# Create demand-focused dataset for analysis
demand_data <- merged_data %>%
  filter(type == "D") %>%  # Focus on demand data
  filter(!is.na(energy_value), !is.na(temp_mean)) %>%  # Remove missing values
  mutate(
    temp_squared = temp_mean^2,  # Quadratic term for U-shape
    temp_centered = scale(temp_mean, scale = FALSE),  # Centered temp for easier interpretation
    temp_centered_squared = temp_centered^2,
    log_energy = log(energy_value),
    
    # Additional derived variables for advanced analysis
    temp_cubic = temp_mean^3,  # Cubic term for potential asymmetry
    temp_humidity_interaction = temp_mean * humidity_mean,  # Interaction term
    heat_index = case_when(
      temp_mean >= 80 & humidity_mean >= 40 ~ 
        -42.379 + 2.04901523 * temp_mean + 10.14333127 * humidity_mean - 
        0.22475541 * temp_mean * humidity_mean - 0.00683783 * temp_mean^2 - 
        0.05481717 * humidity_mean^2 + 0.00122874 * temp_mean^2 * humidity_mean + 
        0.00085282 * temp_mean * humidity_mean^2 - 0.00000199 * temp_mean^2 * humidity_mean^2,
      TRUE ~ temp_mean  # Use regular temperature if heat index conditions not met
    )
  )

# Verify demand data creation
cat("Created demand dataset with dimensions:", dim(demand_data), "\n")
cat("Covering", n_distinct(demand_data$energy_region), "energy regions\n")
cat("Temperature range:", min(demand_data$temp_mean), "to", max(demand_data$temp_mean), "째F\n")
```
